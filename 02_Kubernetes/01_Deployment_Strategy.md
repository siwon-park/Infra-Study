# 01_Deployment_Strategy(배포 전략)

> 배포 전략

## 1. 재생성(Re-Create)

기존 구버전(v1)에 대한 서비스를 모두 중지한 다음, 신버전(v2)에 대한 서비스를 새로 생성하여 시작하는 방식.

젠킨스(Jenkins)를 활용하여 실행 중인 컨테이너를 모두 중지한 다음, 머지된 소스를 배포하는 방식이 재생성 방식이다. 컨테이너 중지 후 빌드에서 배포 과정까지 몇 초에서 몇 분까지 서비스가 중단되기도 한다.

버전 관리만 잘하면 롤백 자체는 간단할 수도 있지만, 롤백 시에도 서비스 중단이 발생하게 된다.

### 1) 장점

- 배포 전략이 간단하며, 아키텍처 및 인프라 구성이 상대적으로 쉽다.
- 많은 자원 사용량을 요구하지 않는다.

### 2) 단점

- 서비스 다운타임(Down time)이 존재한다.

<br>

## 2. 롤링 업데이트(Rolling Update) 배포

기존 구버전(v1)이 존재하는 상태에서 신버전(v2)를 배포하고, 이상이 없을 경우 v1을 점차 줄이고 v2를 추가 배포하는 방식의 배포 전략. 

신버전의 서버를 만들어가면서 트래픽을 구버전에서 신버전으로 서서히 점진적으로 옮겨가는 형태로 배포가 된다.

- 단 별도의 트래픽 제어 없이, 구버전과 신버전에 자동 분산하는 방식이다.

서비스가 정상인 상태에서 요구하는 자원을 기준으로, 블루/그린 배포가 인프라 리소스가 최대 2배 정도 더 소요되는 반면, 롤링 업데이트 배포 방식은 서버 자원이 그보다 더 적은 한정적인 경우에 조금 더 유리하다.

- 방법1) 기존 v1에 대한 인스턴스는 유지한 상태에서 v2에 대한 인스턴스를 추가한 다음, 성공적일 경우 v1에 대한 인스턴스를 줄이고 v2 인스턴스를 기존 v1만큼 증가시킨다.
- 방법2) 기존 v1에 대한 인스턴스를 하나 줄이고 v2에 대한 인스턴스를 추가한 다음, 정상적일 경우 v2에 대한 인스턴스를 늘리고 v1에 대한 인스턴스를 줄인다.

### 1) 장점

- 서비스 다운타임이 없다.
- 버전의 업데이트와 테스팅을 동시에 수행할 수 있다.

### 2) 단점

- 배포가 점진적으로 이루어지므로 구버전과 신버전이 공존하는 시기에는 두 버전을 모두 고려하여 개발을 진행해야 한다.
- 기존 인스턴스를 하나 줄이고 신규 배포하는 경우라면
  - 배포 중 한쪽의 인스턴스 수가 감소되므로 서버의 처리 용량을 미리 고려해야한다.
  - 서버가 롤링 업데이트 상태로 넘어갈 때 기존 서버에 접속하고 있던 사용자의 세션을 어떻게 신규 서버로 이전시킬지 고려해야 한다.

- 롤백이 간단하지는 않다.
  - 롤백 시에도 이미 일부가 신버전이어서 구/신버전이 혼합되어 있다.
  - 신버전으로 거의 다 전환된 상태에서 문제가 발생할 경우 빠른 롤백이 쉽지 않을 수도 있다.


![image](https://user-images.githubusercontent.com/93081720/196716473-3b2102ae-86d8-49d1-b8b6-dc8e5f742db1.png)

<br>

## 3. 블루/그린(Blue/Green) 배포

구버전(v1)을 블루, 신버전(v2)을 그린이라고 해서 이름이 붙여진 배포 방식.

많이 사용하는 배포 전략 중 하나로, 신버전의 배포를 모두 완료한 뒤에 로드밸런서를 통해 트래픽을 구버전에서 신버전으로 전환하는 방식의 배포 전략을 말한다.

### 1) 장점

- 빠른 롤백이 가능하다. 배포된 신버전에 문제가 있을 경우 로드 밸런서만 설정하면 트래픽을 다시 구버전으로 옮길 수 있다.
- 서비스 다운 타임이 없다. 로드밸런서의 트래픽을 구버전에서 신버전으로 옮기기만 하면 된다. (이 찰나의 순간에 접속이 불가능할 수도 있긴 하지만 무중단 배포로 본다.)
- 실제 서비스 환경에서 신버전에 대한 테스트 환경을 구성할 수 있다.

### 2) 단점

- 인프라 리소스가 2배(블루, 그린)로 소요되므로 비용 많이 든다.
- 기존 운영 중인 블루에서 Long-term 트랜잭션이 수행 중이었다면 그린으로 전환 시에 어떤 방식으로 처리할 것인지에 대한 이슈가 있다.
- 두 서버 환경 간 migration이 배포 때마다 필요하며, Rollback 수행 시에도 마찬가지로 고려해야한다.

![image](https://user-images.githubusercontent.com/93081720/196718080-0f23ed23-fcea-46bd-8c20-11db2c0ec65a.png)

<br>

## 4. 카나리아(Canary) 배포

옛날 광부들이 광산에서 유독 가스가 나오는 것을 확인하기 위해 가스에 민감한 카나리아 새를 이용한 것에서 유래한 배포 방식.

일정 비율로 일부 서버에만 신버전(v2)을 신규 배포하여 운영(테스트)하면서 문제가 없음이 확인되면 그 비율을 점차 늘려가면서 모든 서버에 신버전을 배포하는 방식.

![image](https://user-images.githubusercontent.com/93081720/196717421-038b6e99-c823-4739-b991-2539ce490ccf.png)

### 1) 장점

- 일부 트래픽을 신버전으로만 보내서 운영 중인 상태에서 실제 서비스 환경을 빠르게 테스트하여 잠재적 위험을 빠르게 감지 가능하다.
- 실제 트래픽을 보내기 때문에 성능 모니터링에 유용하며, 로드밸런서를 통해 롤백도 간단하게 가능하다.

### 2) 단점

- 동일 시점에 여러 개의 어플리케이션 버전을 관리해야 하다.
- 배포 전략이 복잡하다.

### 3) 롤링 업데이트 방식과 차이

두 배포 방식 모두 구버전에서 신버전으로 점진적으로 전환한다는 점은 동일하지만, 카나리아 방식의 경우 트래픽을 제어할 수 있다는 가장 큰 차이가 존재한다.

트래픽 비율을 제어하여 일부 트래픽을 신버전에만 보내서 빠르게 운영 환경에서 테스트를 진행할 수 있고, 영향을 받는 범위가 신버전으로 보낸 트래픽과 신버전 인스턴스에만 한정되기 때문에 위험 최소화가 가능하며 롤링 방식에 비해 빠른 롤백도 가능하다.

따라서 카나리아 방식이 롤링 업데이트 방식에 비해 안정적이고, 빠른 대처가 가능한 전략적인 배포 방식이라고 할 수 있다.





